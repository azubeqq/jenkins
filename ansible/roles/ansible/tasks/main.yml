# ansible/roles/ansible/tasks/main.yml
---
    # ========== ANSIBLE ==========
- name: Install Ansible (full package)
  ansible.builtin.dnf:
    name: ansible
    state: present

    # Если нужны дополнительные коллекции через ansible-galaxy
- name: Install Ansible collections via galaxy
  ansible.builtin.command: ansible-galaxy collection install {{ item }}
  loop: "{{ ansible_collections }}"
  register: galaxy_result
  changed_when: "'was installed successfully' in galaxy_result.stdout"
  failed_when:
    - galaxy_result.rc != 0
    - "'is already installed' not in galaxy_result.stderr"

- name: Create Ansible configuration directory
  ansible.builtin.file:
    path: "{{ ansible_config_path | dirname }}"
    state: directory
    mode: '0755'
  when: ansible_config_create

- name: Deploy ansible.cfg from template
  ansible.builtin.template:
    src: ansible.cfg.j2
    dest: "{{ ansible_config_path }}"
    mode: '0644'
  when: ansible_config_create

- name: Verify Ansible installation
  ansible.builtin.command: ansible --version
  register: ansible_version_output
  changed_when: false
  when: ansible_verify_installation

- name: Display Ansible version
  ansible.builtin.debug:
    msg: "Installed Ansible version: {{ ansible_version_output.stdout_lines[0] }}"
  when: 
    - ansible_verify_installation
    - ansible_version_output is defined